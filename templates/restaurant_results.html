{% extends 'base.html' %}

{% block head %}

{% endblock %}

{% block content %}
	<h3>Restaurant search results</h3>
	<p>Select the <span class="glyphicon glyphicon-star-empty"></span> to save a restaurant to your bookmarks, or <span class="glyphicon glyphicon-user"></span> to recommend it to a friend!</p>
	<div class="alert alert-success" role="alert" hidden="true"></div>
	<table class="table table-striped table-hover">
	    <thead>
	        <th>Bookmark</th>
	        <th>Recommend</th>
	        <th>Restaurant</th>
	        <th>Address</th>
	    </thead>
	    <tbody>
		    {% for item in fsq_venues %}
		    	{% if item.location.address is defined %}
				    <tr class='selected-row' data-id= "{{item.id}}" data-name="{{item.name}}" data-lat="{{item.location.lat}}" data-lng="{{item.location.lng}}" data-cuisine="{{item.categories.0.shortName}}" data-address="{{item.location.address}}" data-city="{{item.location.city}}" data-state ="{{item.location.state}}" 
				    data-phone="{{item.contact.phone if item.contact.phone is defined else ''}}" data-url="{{item.url if item.url is defined else ''}}">
				    	<td><button type="button" class="btn add-bookmark">
				        	<span class="glyphicon glyphicon-star-empty "></button></td>
				        <td><button type="button" class="btn recommend" data-toggle="modal" data-target="#myModal"><span class="glyphicon glyphicon-user"></button></td>
				        <td><h5>{{ item['name'] }}</h5>
				        	{% if item.url is defined %}
				        	<p><a href="{{item['url']}}">{{item.url}}</a></p>
				        	{% endif %}
				        </td>
				        <td>{{ item['location']['address'] }} 
				        	<p>{{ item['location']['city'] }}, {{ item['location']['state'] }}</p>
				        </td>
				 	</tr>
				{% endif %}
			{% endfor %}
		</tbody>
    </table>

    <!-- Modal -->
	<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="false">
	  <div class="modal-dialog">
	    <div class="modal-content">
	      <div class="modal-header">
	        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
	        <h4 class="modal-title" id="myModalLabel">Almost done!</h4>
	      </div>
	      <div class="modal-body">
	      	<p>Select the user to recommend this restaurant to:</p>
	        <div class="user-list">
	        </div>
	      </div>
	      <div class="modal-footer">
	        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
	        <button type="button" class="btn btn-primary">Save changes</button>
	      </div>
	    </div>
	  </div>
	</div>

{% endblock %}

{% block js_code %}
	<script>

	$('.add-bookmark').click(function(){
		var $row = $(this).closest("tr");
		// alert($row.data('id'));
		var fsqId = $row.data('id');
		var name = $row.data('name');
		var lat = $row.data('lat');
		var lng = $row.data('lng');
		var cuisine = $row.data('cuisine');
		var address = $row.data('address');
		var state = $row.data('state');
		var city = $row.data('city');
		var phone = $row.data('phone');
		var url = $row.data('url');

		var fsqData = {
				"name": name, 
				"fsqId":fsqId, 
				"lat": lat, 
				"lng": lng, 
				"cuisine": cuisine,
				"address": address,
				"city": city,
				"state": state, 
				"phone": phone,
				"url": url
			}
		//show a message telling user they have bookmarked the restaurant - callback function for get request
		function showMessage(response) {
			$(".alert").html(response.message).show().fadeToggle(3200);
		}

		//get request to URL on server that saves the bkm and restaurant to db as necessary
		$.get("/save-db", fsqData, showMessage);
	});

	$(document).ready(function() {
    	//send a GET request to the server to get all usernames and render them on the page when its done 
		$.getJSON("/user_info", function(json, error){
			if (error){
				console.log(error);
			}

			var userlist = json['username']
			// console.log(userlist)

			$.each(userlist, function(index, value){
				console.log(value);
				// href = "/recommend" + "?username=" + value
				// $( ".user-list" ).append( "<p>" +"<a href="+ href + ">" + value + "</a>"+ "</p>");
				username = value
				$( ".user-list" ).append( "<p>" +"<a data-username="+ username + ">" + value + "</a>"+ "</p>");
			});

			$("a").click(function(event){
				// console.log(event.target);
				usernameRecipient = event.target.getAttribute('data-username');
				console.log(usernameRecipient);
				//send the username data to the server in a GET request to the /recommend route as well as all the other needed information to save this restaurant to the db 
			})
			
		}); //end of GET request
	});

	</script>
{% endblock %}