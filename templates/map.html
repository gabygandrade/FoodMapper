{% extends 'base.html' %}

{% block head %}
	<style>
		html { height:100% }
		body { height: 100%; margin:0; padding:0 }
		.container { height:100% }
		#map-canvas {
	        height: 500px;
	        margin: 0px;
	        padding: 0px
      	}
      	#map-container {
      		width:100%;
      		height:100%;
      	}
    </style>
    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>

{% endblock %}

{% block content %}
	<div class="row">
		<div class="col-md-3">
			<table class="table table-striped table-hover">
				<thead>
			        <th>Your Saved Restaurants</th>
			    </thead>
			    <tbody>
			    	{% for item in restaurant_data %}
			    	<tr data-bookmarkid="{{item[0]}}">
			    		<td>
				    		<h4>{{item[3]}}</h4>
				    		<p>{{item[4]}}</p>
				    		<p>{{item[5]}}</p>
				    		<p>{{item[6]}}, {{item[7]}}</p>
				    		<p><span class="glyphicon glyphicon-earphone"></span> {{item[8]}}</p>		<!--edit this to only show phone icon if there is a phone # -->
				    		<p><a href="{{item[9]}}">{{item[9]}}</a></p>
			    			<button class="btn btn-danger delete-bookmark"><span class="glyphicon glyphicon-trash"></span></button>
			    		</td>
			    	</tr>
			    	{% endfor %}
			    </tbody>
			</table>
		</div>
		<div class="col-md-9">
			<div id="map-canvas"></div>
		</div>
		<!-- <div class="flash-notice"></div>  -->
	</div>

{% endblock %}

{% block js_code %}

<script>
	var map;
	
	function initialize() {
		//define the properties for the map
		  var mapOptions = {
		    zoom: 13,
		    center: new google.maps.LatLng(37.788708799999995,-122.41170040000003)
		  };
  		
  		//create a map object w/parameters from mapOptions
  		map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
		
  		 // Try HTML5 geolocation
		if(navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(function(position) {
			var pos = new google.maps.LatLng(position.coords.latitude,
		                           position.coords.longitude);

			var infowindow = new google.maps.InfoWindow({
			map: map,
			position: pos,
			content: 'Location found using HTML5.'
			});

			map.setCenter(pos);
			}, function() {
				handleNoGeolocation(true);
			});
		} 
		else {	// Browser doesn't support Geolocation
			handleNoGeolocation(false);
		}

		//GET request to get info for markers 
			$.getJSON("/bookmark-info", function(response){
			var json = response;
			console.log(json)
			//loop through each of the json elements, get their lat, lng, name & other info & create a marker for these
			$.each(json, function(key, data){
				var restaurantId = key;
				var lat = data.lat;
				var lng = data.lng; 
				var myLatLng = new google.maps.LatLng(lat, lng);
				console.log(myLatLng)

				var name = data.name
				var cuisine = data.cuisine
				var fsqId = data.fsq_id

				var restcontent = ['<div id="content">',
				'<h3>', name, '</h3>',
				'<p>', cuisine, '</p>',
				'</div>'].join('');

				//Create markers with the info from the getJSON request
				var marker = new google.maps.Marker({
					position: myLatLng,
					map: map
				}); 
				//add the markers to the map 
				marker.setMap(map);

				//Add an info window with the information about the restaurant
				var infoWindow = new google.maps.InfoWindow({
  					content: restcontent
			 		});
			 		
		 		//add event listener to marker to show infowindow on mouseover of marker
				google.maps.event.addListener(marker, 'mouseover', function() {
					infoWindow.open(map,marker);
				});

				//add event listener to marker to close infowindow on mouseout of marker
				google.maps.event.addListener(marker, 'mouseout', function() {
					setTimeout(function () {
						infoWindow.close(map,marker); 
						}, 
					'2500');
				});
			}); //end of $.each method
		}); //end of GET request ---------------------------- 

	} // End of initialize function -----------------------

	//function to handle when Geolocation fails or browser doesn't support geolocation
	function handleNoGeolocation(errorFlag) {
		if (errorFlag) {
			var content = 'Error: The Geolocation service failed.';
		} else {
			var content = 'Error: Your browser doesn\'t support geolocation.';
		}

		var options = {
			map: map,
			position: new google.maps.LatLng(37.788708799999995,-122.41170040000003),
			content: content
		};

		var infowindow = new google.maps.InfoWindow(options);
			map.setCenter(options.position);
	}

	//event listener to load the map when page is loaded
	google.maps.event.addDomListener(window, 'load', initialize);

	//script to handle when user deletes bookmark
	$('.delete-bookmark').click(function(){
		var $row = $(this).closest("tr");
		var bookmarkId = $row.data('bookmarkid')
		// alert(bookmarkId);

		//data to be sent along with GET request
		var bookmarkData = {
			"bookmarkId": bookmarkId, 
		}
		
		//callback function to be run after get response back from GET request
		function reloadPage(response) {
			location.reload();
			// google.maps.event.trigger(map, 'resize');
			// $(".flash-notice").html(response.message).show().fadeToggle(6000);
		}

		$.get("/delete-bookmark", bookmarkData, reloadPage);
	});	

</script>

{% endblock %}
