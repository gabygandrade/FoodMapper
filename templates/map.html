{% extends 'base.html' %}

{% block head %}
	<style>
		html { height:100% }
		body { height: 100%; margin:0; padding:0 }
		.container { height:100% }
		#map-canvas {
	        height: 500px;
	        margin: 0px;
	        padding: 0px
      	}
      	#map-container {
      		width:100%;
      		height:100%;
      	}
      	#map-div {
      		padding-left:0px;
      		padding-right:8px;
      	}
		#list { width:100%; background:#eee; list-style:none; padding:0; max-height:480px; overflow-y:auto;} 
		#list li { padding:10px; } 
		#list li:hover { background:#555; color:#fff; cursor:pointer; cursor:hand; }
		#list-div {
			padding-left:0px;
			margin-right:-8px;
			padding-right:0px;
		}
    </style>
    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
{% endblock %}

{% block navbar %}
	<li>
	    <form class="navbar-form navbar-left" role="search" form action="/restaurant-results" method="GET" id="add-rest">
	      <div class="form-group">
	        <label>Search:<input type="text" name="search-restaurant" class="form-control" placeholder="Ex. Limon Rotisserie">
	        <label>Near:<input type="text" name="search-location" class="form-control" placeholder="Ex. San Francisco, CA">
	      </div>
	      <button type="submit" class="btn btn-default" id="submit-query">Submit</button>
	    </form>
	    <li><a href="/recommendations">Recommendations</a></li>
	    <li><a href="/map">My Map</a></li>
	    <li><a href="/logout">Log Out</a></li>
	</li>
{% endblock %}

{% block content %}
	<div class="row">
		<div class="col-md-9" id="map-div">
			<div id="map-canvas"></div>
		</div>
		<div class="col-md-3" id="list-div">
			<h4>My Bookmarked Restaurants </h4>
			<ul id="list"></ul>
		</div>
	</div>

{% endblock %}

{% block js_code %}

<script>

	var map;

	$('body').delegate('.delete-bookmark', 'click', function (event) {
		var bookmarkId = $(this).data('bookmarkid')
		// console.log(bookmarkId);

		// data to be sent along with GET request
		var bookmarkData = {
			"bookmarkId": bookmarkId, 
		}
		
		//callback function to be run after get response back from GET request
		function reloadPage(response) {
			location.reload();
		}

		$.ajax({
			method: 'POST',
			url: '/delete-bookmark',
			dataType: 'json',
			data: bookmarkData,
			}).done(reloadPage);
		});

	function initialize() {

		//create array to hold style for map styles

		var styles=[{"featureType":"administrative","elementType":"geometry","stylers":[{"saturation":"1"}]},{"featureType":"administrative.country","elementType":"all","stylers":[{"visibility":"on"}]},{"featureType":"administrative.country","elementType":"labels","stylers":[{"saturation":"-100"}]},{"featureType":"administrative.province","elementType":"all","stylers":[{"visibility":"on"}]},{"featureType":"administrative.province","elementType":"labels","stylers":[{"lightness":"1"},{"saturation":"-100"}]},{"featureType":"administrative.locality","elementType":"geometry","stylers":[{"saturation":"-100"},{"visibility":"off"},{"hue":"#ff0000"}]},{"featureType":"administrative.locality","elementType":"geometry.fill","stylers":[{"saturation":"4"}]},{"featureType":"administrative.locality","elementType":"labels","stylers":[{"saturation":"-100"}]},{"featureType":"administrative.neighborhood","elementType":"geometry","stylers":[{"saturation":"-100"}]},{"featureType":"administrative.neighborhood","elementType":"labels","stylers":[{"saturation":"-100"}]},{"featureType":"administrative.land_parcel","elementType":"geometry","stylers":[{"saturation":"-100"}]},{"featureType":"administrative.land_parcel","elementType":"labels","stylers":[{"saturation":"-100"}]},{"featureType":"landscape","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"landscape","elementType":"geometry","stylers":[{"visibility":"off"},{"saturation":"-100"}]},{"featureType":"landscape","elementType":"geometry.fill","stylers":[{"visibility":"on"},{"color":"#ffffff"}]},{"featureType":"landscape","elementType":"geometry.stroke","stylers":[{"visibility":"on"}]},{"featureType":"landscape.man_made","elementType":"all","stylers":[{"saturation":"4"}]},{"featureType":"landscape.man_made","elementType":"geometry","stylers":[{"saturation":"-100"}]},{"featureType":"poi","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"poi.attraction","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"road","elementType":"all","stylers":[{"lightness":"16"},{"saturation":"-7"}]},{"featureType":"road.arterial","elementType":"geometry","stylers":[{"saturation":"0"}]},{"featureType":"road.local","elementType":"geometry","stylers":[{"saturation":"-100"}]},{"featureType":"water","elementType":"all","stylers":[{"visibility":"on"},{"color":"#002855"}]},{"featureType":"water","elementType":"geometry","stylers":[{"weight":"1.12"}]},{"featureType":"water","elementType":"geometry.fill","stylers":[{"lightness":"-14"},{"saturation":"-14"},{"color":"#18355f"},{"gamma":"1.23"}]},{"featureType":"water","elementType":"geometry.stroke","stylers":[{"weight":"0.50"},{"lightness":"0"}]},{"featureType":"water","elementType":"labels","stylers":[{"weight":"0.50"},{"color":"#ffffff"}]}]

		// var styles=[{"featureType":"landscape","elementType":"geometry","stylers":[{"saturation":"-100"}]},{"featureType":"poi","elementType":"labels","stylers":[{"visibility":"off"}]},{"featureType":"poi","elementType":"labels.text.stroke","stylers":[{"visibility":"off"}]},{"featureType":"road","elementType":"labels.text","stylers":[{"color":"#545454"}]},{"featureType":"road","elementType":"labels.text.stroke","stylers":[{"visibility":"off"}]},{"featureType":"road.highway","elementType":"geometry.fill","stylers":[{"saturation":"-87"},{"lightness":"-40"},{"color":"#ffffff"}]},{"featureType":"road.highway","elementType":"geometry.stroke","stylers":[{"visibility":"off"}]},{"featureType":"road.highway.controlled_access","elementType":"geometry.fill","stylers":[{"color":"#f0f0f0"},{"saturation":"-22"},{"lightness":"-16"}]},{"featureType":"road.highway.controlled_access","elementType":"geometry.stroke","stylers":[{"visibility":"off"}]},{"featureType":"road.highway.controlled_access","elementType":"labels.icon","stylers":[{"visibility":"on"}]},{"featureType":"road.arterial","elementType":"geometry.stroke","stylers":[{"visibility":"off"}]},{"featureType":"road.local","elementType":"geometry.stroke","stylers":[{"visibility":"off"}]},{"featureType":"water","elementType":"geometry.fill","stylers":[{"saturation":"-52"},{"hue":"#00e4ff"},{"lightness":"-16"}]}]

		// blue and gray
		// var styles=[{"featureType":"administrative","elementType":"labels.text.fill","stylers":[{"color":"#444444"}]},{"featureType":"administrative.locality","elementType":"labels.text.fill","stylers":[{"visibility":"simplified"},{"color":"#a17d43"}]},{"featureType":"administrative.locality","elementType":"labels.text.stroke","stylers":[{"visibility":"simplified"},{"saturation":"13"},{"lightness":"50"},{"gamma":"1.95"},{"weight":"0.01"}]},{"featureType":"landscape","elementType":"all","stylers":[{"color":"#f2f2f2"}]},{"featureType":"poi","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"road","elementType":"all","stylers":[{"saturation":-100},{"lightness":45}]},{"featureType":"road.highway","elementType":"all","stylers":[{"visibility":"simplified"}]},{"featureType":"road.arterial","elementType":"labels.icon","stylers":[{"visibility":"off"}]},{"featureType":"transit","elementType":"all","stylers":[{"visibility":"off"}]},{"featureType":"water","elementType":"all","stylers":[{"color":"#46bcec"},{"visibility":"on"}]},{"featureType":"water","elementType":"geometry.fill","stylers":[{"saturation":"-44"},{"color":"#0b6a9b"},{"lightness":"2"}]},{"featureType":"water","elementType":"labels.text.fill","stylers":[{"visibility":"off"},{"hue":"#ff0000"}]}]

	
		// Create a new StyledMapType object, passing it the array of styles,
		// as well as the name to be displayed on the map type control.
		var styledMap = new google.maps.StyledMapType(styles,
		{name: "Styled Map"});

		// Create a map object, and include the MapTypeId to add
		// to the map type control.
		var mapOptions = {
			zoom: 13,
			center: new google.maps.LatLng(37.788708799999995,-122.41170040000003),
			scrollwheel: false,
			mapTypeControlOptions: {
			mapTypeIds: [google.maps.MapTypeId.ROADMAP, 'map_style']
			}
		};

		//create a map object w/parameters from mapOptions
		map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
		
		//Associate the styled map with the MapTypeId and set it to display.
		map.mapTypes.set('map_style', styledMap);
		map.setMapTypeId('map_style');

  		 // Try HTML5 geolocation
		if(navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(function(position) {
			var pos = new google.maps.LatLng(position.coords.latitude,
		                           position.coords.longitude);

			var geolocationInfoWindow = new google.maps.InfoWindow({
				map: map,
				position: pos,
				content: 'Location found using HTML5.'
			});

			//add event listener to marker to close infowindow on mouseout of marker
			google.maps.event.addListener(geolocationInfoWindow, function() {
				setTimeout(function () {
					infoWindow.close(map,marker); 
					}, 
				'2500');
			});

			map.setCenter(pos);
			}, function() {
				handleNoGeolocation(true);
			});
		} 
		else {	// Browser doesn't support Geolocation
			handleNoGeolocation(false);
		}

		//GET request to get info for markers 
			$.getJSON("/bookmark-info", function(json){
			console.log(json)
			//loop through each of the json elements, get their lat, lng, name & other info & create a marker for these
			$.each(json, function(key, data){
				var bookmarkId = key;
				var lat = data.lat;
				var lng = data.lng; 
				var myLatLng = new google.maps.LatLng(lat, lng);
				// console.log(myLatLng)

				var name = data.name
				var cuisine = data.cuisine
				var fsqId = data.fsq_id
				var address = data.address
				var phone = data.phone
				var url = data.url
				var icon_url = data.icon_url
				// if (data.recommender_username !== undefined): 
				var recommender_username = data.recommender_username

				var listContent = ['<div id="content">',
					'<h4>', name, '</h4>',
					'<p><i>', cuisine, '</i></p>',
					'<p>', address, '</p>', 
					'<p>', phone, '</p>',
					'<p>Recommended by: ', recommender_username, '</p>',
					'<p>','<a href=', url, '>', url, '</a>','</p>',
					'<button class="btn btn-danger delete-bookmark"', 
					'data-bookmarkid="', bookmarkId, 
					'">','<span class="glyphicon glyphicon-trash"></span></button>',
					'</div>'].join('');

				var iconBase = icon_url

				var customIconUrl = iconBase + 'bg_32.png'

				//Create markers with the info from the getJSON request
				var marker = new google.maps.Marker({
					position: myLatLng,
					map: map,
					icon: customIconUrl
					// if this fails, replace category with 'default'
				}); 
				//add the markers to the map 

				marker.setMap(map);

				$("<li/>").attr('data-bookmarkid',bookmarkId).html(listContent).click(function(){ 
						map.panTo(myLatLng); 
						infoWindow.open(map,marker);
					}) 
				.appendTo("#list");

				//Add an info window with the information about the restaurant
				var infoWindow = new google.maps.InfoWindow({
  					content: listContent
			 		});
			 		
		 		//add event listener to marker to show infowindow on mouseover of marker
				google.maps.event.addListener(marker, 'click', function() {
					infoWindow.open(map,marker);
				});
			}); 
		});

	} // End of initialize function -----------------------

	//function to handle when Geolocation fails or browser doesn't support geolocation
	function handleNoGeolocation(errorFlag) {
		if (errorFlag) {
			var content = 'Error: The Geolocation service failed.';
		} else {
			var content = 'Error: Your browser doesn\'t support geolocation.';
		}

		var options = {
			map: map,
			position: new google.maps.LatLng(37.788708799999995,-122.41170040000003),
			content: content
		};

		var infowindow = new google.maps.InfoWindow(options);
			map.setCenter(options.position);
	}

	//event listener to load the map when page is loaded
	google.maps.event.addDomListener(window, 'load', initialize);

</script>

{% endblock %}
